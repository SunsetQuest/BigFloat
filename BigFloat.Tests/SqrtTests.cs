// Copyright Ryan Scott White. 2020-2025
// Released under the MIT License. Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sub-license, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
// The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
// Starting 2/25, ChatGPT/Claude/GitHub Copilot/Grok were used in the development of this library.

// Ignore Spelling: Sqrt

using System.Diagnostics;
using System.Numerics;
using System.Text;

namespace BigFloatLibrary.Tests;

public class SqrtTests
{
    /// <summary>
    /// Target time for each test. Time based on release mode on 16 core x64 CPU.
    /// </summary>
    private readonly int TestTargetInMillseconds = 100;

#if DEBUG
    private const int MaxDegreeOfParallelism = 1;
    private const long sqrtBruteForceStoppedAt = 262144;
    private const long inverseBruteForceStoppedAt = 262144;
#else
    readonly int MaxDegreeOfParallelism = Environment.ProcessorCount;
    const long sqrtBruteForceStoppedAt = 524288;
    const long inverseBruteForceStoppedAt = 524288 * 1;
#endif

    private const int RAND_SEED = 22;// new Random().Next();
    private static readonly Random _rand = new(RAND_SEED);


    [Fact]
    public void Verify_Math_Sqrt()
    {
        BigFloat inputVal, valExpect, valResult;
        inputVal = new BigFloat("2.00000000000", 0);
        BigFloat val = BigFloat.Sqrt(inputVal);
        string output, expect;

        inputVal = new BigFloat("49");
        output = BigFloat.Sqrt(inputVal).ToString();
        expect = "7.0";
        Assert.Equal(output, expect);

        output = val.ToString();
        //        2.00000000000                            // 10.000000000000000000000000000000000000
        expect = "1.41421356237";
        //        1.41421356237 is best, but 1.414213562373 are acceptable 
        //        1.4142135623730950488016887242097           1.0110101000001001111001100110011111110 0111011110011001001000010
        Assert.Equal(output, expect);

        inputVal = new BigFloat("200000000000");
        output = BigFloat.Sqrt(inputVal).ToString();
        //        447213.595499                    // okay  1101101001011101101.100110000111001010011111010110011100110011111010111011111111010111000110110000010001101000..
        expect = "447213.595500";                  // best  1101101001011101101.100110000111001010110000001000001100010010011011101001011110001101010011111101111100111011...
                                                   //        447213.59549995793928183473374626   exact 1101101001011101101.100110000111001010101111011011000001111001011011111110110110010000111100001011000010100010...
        Assert.Equal(output, expect);

        inputVal = new BigFloat("0.0215841551");
        output = BigFloat.Sqrt(inputVal).ToString();
        //          215841551
        expect = "0.146915469";  //146915469(best) or 146915469[1-5](okay)
                                 //        0.14691546923316142068618979769788 //more precision on another system
                                 //       0.0215841551
        Assert.Equal(output, expect);

        inputVal = new BigFloat("0.000000001");
        output = BigFloat.Sqrt(inputVal).ToString();
        expect = "0.00003";
        //        0.000031622776601683793319988935444327 //more precision on another system
        Assert.Equal(output, expect);

        inputVal = new BigFloat("98765432109876543210987654321098765432109876543210987654321098765432109876543210");
        output = BigFloat.Sqrt(inputVal).ToString();
        //        9876543210987654321098765432109876543210 9876543210987654321098765432109876543210
        expect = "9938079900558082311789231964937550558064.6494438268544270221286846603357167897049";
        // exact: 9938079900558082311789231964937550558064.64944382685442702212868466033571678970487057062388... 
        Assert.Equal(output, expect);

        inputVal = new BigFloat("0.98765432109876543210987654321098765432109876543210987654321098765432109876543210");
        output = BigFloat.Sqrt(inputVal).ToString();
        //        0.98765432109876543210987654321098765432109876543210987654321098765432109876543210
        expect = "0.99380799005580823117892319649375505580646494438268544270221286846603357167897049";
        //        0.993807990055808231178923196493755055806464944382685442702212868466033571678970487057062388 //more precision on another system
        Assert.Equal(output, expect);

        inputVal = new BigFloat("23466207109390852182562229134844879465209207461285119050842725537452100070948111321244695716285488004820807390076326731850692667100714992415364312032227360362070027890120698082826669803953958791443305257455513984934956578611336998676672804562842121688708383087759159988954760747537602550118269197135294250359262819649936574767063922.01945122219918131773");
        valResult = BigFloat.Sqrt(inputVal);
        output = valResult.ToString();
        expect = "4844193132957319671709340941797445984823847916300558971839295375794565129018082952319997856028164815858716997110257694105883395223009099123324505808832930067526997557.67942784382363710559954840909262062040844976811740121716293669295087565452542991248498736784872402435202193650709055844125266714299502864068900000000000000000000000000000000000000000000";
        // exact: 4844193132957319671709340941797445984823847916300558971839295375794565129018082952319997856028164815858716997110257694105883395223009099123324505808832930067526997557.67942784382363710559954840909262062040844976811740121716293669295087565452542991248498736784872402435202193650709055844125266714299502864068899999999999999999999999999999999999999999999949320041843783
        Assert.Equal(output, expect);
        valExpect = new BigFloat("4844193132957319671709340941797445984823847916300558971839295375794565129018082952319997856028164815858716997110257694105883395223009099123324505808832930067526997557.679427843823637105599548409092620620408449768117401217162936692950875654525429912484987367848724024352021936507090558441252667142995028640689");
        Assert.True(valResult.EqualsUlp(valExpect));
    }

    [Fact]
    public void Verify_NewtonPlusSqrt_Common_Fails()
    {
        BigInteger temp;

        temp = BigInteger.Zero;
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp)));

        // Covered under the Verify_NewtonPlusSqrt_Brute_Force.
        //temp = BigInteger.Parse("4");
        //temp = BigInteger.Parse("15");

        temp = BigInteger.Parse("4503599761588224");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp)));

        temp = BigInteger.Parse("144838757784765629");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp)));

        temp = BigInteger.Parse("4332296397072526994426");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp)));

        temp = BigInteger.Parse("197120777410685286861723419348662720446983624468633941814867274161329731855");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp)));

        temp = BigInteger.Parse("568596673212406235539046204653574092779927528240990410308704492396460002250762210750361428976428226236231439839658527797601369407516351767038245884193317345297332639084030064798571562357325869523334241343457316070779167053230802243325508166810051970793029610805741205436326081505118688824250695502334609951573043497313485532249651668225178016840421469883558806604285808368323341479822807033581983205344039371458847573584264752900519079048915398981011181623230780288048890300634904517965949212204068737098107941104189698397409567698012505870983478073274795514339034169365773220230830720004807771185986855895045516625461415107861041712612909415282678933430993639015017973044506087648363018729847627791605903425315716867660373283634463025466898314552226041199227082594230096271404048950683874734785456093637644080259923926309749113053869920861252071824902816983919198943333352747567573205971722594392368757236981129345325357188283747755165211300361598909057331888013394644712040562578111312045020011010991816673666598318790155764029251076097495451756886293433937287357398346137053436703441717477280156524220517544784355270939618075800550360950261327034177704356076938995007627050124084857312674697721104308993667110188079684610462970532770811430407577836576516525347984663742735894854393178929653419127586692542189167843310656882269150136996004592038958466538491947533727965371911271931474363560773806290903082464818620463658436801310707825375068269725362589748265742091637498362621850566516960404061662197346676810108676564947944053523430298498377965136876382874888755098780874762932647407939626869067245075305802595524491063488862288004615122286564843300578758861996842723888825626998296253860396832728618268698513999105663450448455591453911622931238399649235353903164331408715648544484198462915062815114371906052899024506631206302172485246425734102246282006790515841269176368354750944457205740865919396101592164443131178363631180186481154637375276513183701970126748221898210963776797851581007115533834804644343822008468228860094391251339086238465678711921921284967851031385031907419916767858003766595842244869449534509496748434950293981618989570054257983701817992679002284807232891636649497294174834055117140618871480275671453660871756346174812413763546753450026532970380652053777318975717905464523846316531635812393163893169715944468523807676593337865609836993849998617745398537861679170415965793630853028066627328675239723557343598380919099547947117124600794798069455211709821342706038292764227379487605537218318247566029210526464224355667262491214506233857732726704711260425183953510241304266161977666456048204419815901425751876965458230836272990822362376876246567929545106942228163519038240884565231374383262437933921682301042259394323384010986971478111167473189572624136900260842462563632164438243406573308292515335842446029470620153455750269492648502995752698839327318101471308195682068310941060522835002396271185878639534383332814526736730627737675311440925963840167979468823970109167743381899347507787042067457538898702507081788658375961558876519917419284295948484882059236624597063874422807420548386494638142661819447373680561474726020600212494965888772592905717450857077427720367172542629011169439451164789672353614751341788973143362728269876015374623199859749885177199865505249137720400675981797711570054912715025084920361018230684483048532553044351189092760249689620742581712189291998116260173085751887604161409277198749738705418188423325214210791436123865095895924870449787198921748406270195538419589929583571270220608276936976047435099002481081568006269184926746075413902095833213112716082651523466102709809765278868521868323119552163151078268298543092909181764094354421443739939102266618363082870756251734285570963705511926675021687571952918187727056741057433095113623046731136780044772629021222742048526819043564191009305901298547848411807561630976907033779660614988066747079217915126796269532241434824559034294551034567089930561187776063042962098376001055021975735594097154610662494227608391831324251819834849972727806898988047156642000444156374099020509496337413749154812935620746943658043566102396889370920743841762392784731892754856936207021618371850662875222101060948251861698244863970080362619038241610264649305147250851826137983717857787292617945678440789654915586664827700527372511102728500979579398643014513213916697791050137689464063898748385088697075494961738641464073679536486848774189038880714063768855876078617505553790225908239315278348914126700695635803110855185780815614549031475503058796620205024302283909168380777135676289136283202774805599924261375761188156533898405212485642815583559044372013559333161812445651874731406291358975389500184031405897796170361475824855865416996816101180577179211466498528422630318977338028015876113173714172700603294777292007011893140268292139031620419978838233874410683183389592330610012298019178543866221491941389015906603598594523857857828887538768270002115444064670246189471105302854904357142640940815690815734212236064510656653497518955499351963564298916187123224379625736828158748021096975654285608875084594416617349440558333862887122384581582621428905712789260430593638211814462714113337065254852187384002227801421778675360047475402608367224990354216772160982391869523318958043157276234232215594952081263397029345447393215331410760682924198274455705944715191010466822858771476567511651447291833709417664994052378535962785039458646535298796251823002497493739453107285588189345055064989468830654731943635755096663118764896699043462398498063855211918516506112449276535417359689692816934359580186655249122981543576662853443920537700756370071176061687748929211550413374463270060822541705443889568085981718411771212910543081641827053808927056261093615521865229815551648410013951889654447956505928765294673621144189425512678052272847811478536361635041037247376079729955183288034878518775882046345262042085840029108259221965326603011451402215189442292326949370373918443853583166196123334746715570385322755860325668018143340905234499599661770553181685425109623262543554842563091462152389684151335425459512757268182388248548523806002139043631636292746232049543450881373125665610482569105547103522944485323651945010132405329295466906186502963615807071377352577596402482171032894689185345703931237197465495582572835620049008345615416894296528929647879711273709072418138224125107429443618724331758238114288955335876006203475145403711957920226577816782199167434890841283968630429187388429297294594396082808367568391279858533434198593052588130438526062765357196625443946092250933148070571533443620438382567098056574401350203053743912618224443564964963443981705183424089707049132420709512811684110954808225750117291699279190814324766521785636930646857218211339050239728030407504252402281110555437220027611206852489981972335663826111509206274876677013594436818577024753697807160957110918683574700041515759818141929214696536737555054156463211781351270996437552588723233229968280241742959860248850145435451592696399504097017400658966435059320799049397167451625262640117821825408096184107986323793568374539075737342874384546075573443054746055797583589009325216800125861872312825727671724348718906475191691504698280148131491140967107650139462912226865980464987962788562821048754369500679830978859725690019966684659376992815514045818430491026939697467871051042324292828993612736362860526073881154128878164128599611551530542310658302503782893657116944936194648228308865028057607312143533193693276156368189379813543149482685350792790900828570877584724011390068030679428412329640096515459755446277254206795751336660534427014290278841915158071763997616948849295574651034991146490119782815733533690996854686822010136733628846720978622539379847979030187244911605202840143861781982888178795784849924776497393293251973778927673416094397274685411386366555150802162781628659406215666823246623165293809466708313281347029191907077218303008657606493723248678087195932972884404760267321772756889788034941676516109268379862672702988397543495729736053680904777823723687628080981561711050363322368414855010665896948734225989419949098919172314701355903983867077527964924292955188146625777356737268809184825688808727316372675679905612856708689910533140809777396520507481327364392903800382176843167097065576641359796355206255921794399479538490606924139256862692724352340257725289913772940861331250854604953474112127163651856327913992832600123879966765945027720897535126324356794186885712704393607569538708105218104098849209423758863143894085086521731190291213196696379305734158272203101824107379076013035076712234971563844659606120406749074695967924573761014310011944566766342932466508424800571668641713486290921461220902791729023092771013548720715052229192246483610110598593104826970969087806572025329199569944106409193771552798814229945092476861583524722722759112066195996832270583763580479784998191784157314172850935658197344181379452332323193615353475333080892522126019108669481315395243573395324665363237446275972016556276331960182906303806899636009927546780543980346488212445140028771356388091942552442803773188008085351584825331255325030728733841409046107296730339245186862892760570481181616153002140782747878123422642967197887773195118140973221908721712441299887200866209083986770666824257088245624210982913142488708791987999144692110825246610047377251697461317512198538491122770376600660555409811367120173388378864060067155455090713541086467734664217720993609926519612776700477174101888188993458884880678252772213470425870780423917552701421891594456827968463820740935159076965202859200886098119890641044112881824831639132512603547695921402281940932405417994997938702814783404646751173368769430287371382741376186138486209145164636826028569305579088510904269435098378605169160732461767439018571424555136824347744527082607528180785762004430782108476943616681422686369572684280347505608117430283967292298696789525942300497917954715161971484652463862582725536721104119418568020996161818601764632840636654512368265608739854877931293276921822972877637476652414189723163275512609800132204020956071479807078747845492246682750495407588012902148137602445392176004165882375624372971093548185310117781416021878766399749320798339753778763002071834838306505750050805540210201136326020621556855005961134616936531575783426741040255892005909751600522657015249622142126076979990690329503176083139283356214159398656550117855920963884388077339193608835643128361137119861234131388516866300141373858812640966673370208976799490665174350806186760932933142007086682804757500330217466112164002695550502935300774079412928586340785624656954700151339024544642095334737169097624334788472340640760991267874048831593849530914907470681401965682331359610472406029801405712218159877957333208758173834527023282453958732806282317437672436010620079619244570903695496127956956370537136100022623247986844149235756854737785008277115265923928165200225322336346459556753143202165172227589300527336518245297791085001356912548092099238245360700904251961806593017791798456151653909623459064981589910213870726571579248087879927563066384322856888956287583958965883356240509710864472300769026240045989417656762302396004755336300292521981524065962669490439929857862990319598994639527337122261314730682010056463040758759229889469623898712489719894803269114736500294656194415411869308406146183676054911313131576490647259320992587418054623431837487101604749635114422516499029219293563309281873120759088798895107585724608028263483751331564960049361692704843923785240777313723141453380005341554361639106359775060438287533523856932311422822902626821353904546321484240526585044350171088733439015781558642861065686090670546148571755491286609432057060043971666742286929123667582156169592438262264874070917970547323393649441643765658590865329264618839034301964877180176616403723280116891858186445030814169336508840411566050522180360021655721892781045068966149022578480880921209467602646549684170791500075860710762219336741044349075645200291919578682567332551703896463617259078795321898551974712455647120157245246302781579972253305371481572681034639914639300323011324097949748477310566362105763912344548012887103371826153953590397376115194569981433472808913562082278719594578119855935945569601702547936472782015206840585788231913151015093662983988417437045652418696833683466810782825130439414165774425720297653926967414456360568582558597443506721014596982536734082869106415898445244563135907319363754872172732968447400156320191672297712593724792947325051014248915874773651986723659919087113447245598165982260966270996855626015566461178715461446100650588392938743410774620631872835529431975415586482202897851113697427399684025977623533827867513660088600035366734999866788911160860417088431720747173113244497590518629084473281861361283399287991613303988316391104279108152188690308248779942580210521290025393058453299589362878325391924052007947284168720206307284670229558925312818188165898373997681761608045055177236603993020863977914314891842571099458801905126172967955860909914918248496128402431735678905186029032850506351096008393724932390617611975528997095896345764537644314187545496811248642037001876864656020866004278021777761041348263458447185585845471066467853418222600902676527198074498128418084033054178895168187506127544181648175505145324458999126697899163798209934081");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp)));

        temp = BigInteger.Parse("3069442491521288882209912198117542685828244445905690595315578257576026925040003666991889175682390308936323311867038463231490746054685241129120234622000159636586371418712969328339618031154071244120791357576614510041502582933263867565326846833636258354336203659164264481477059261848349918717073176414771008286700543434325474444449281438222251793946891850998116797072652530702407793152000333188429567050812235397506192494548530491291118797409487643364978182787322328448530443362866083337031188757267098345726710434955949268377737390836920451119678791106540362808087964617692057966401075660464587924580608108398968250310775222716116115842124693003674389514501976582298711620937002974383619569023753418480367573767467109933985464413077005010973797700627360476030427905268125619163045870901316889850082561993497291168719068022883738752815867042916842718745541070994482039679939849686799177261959589642760853561386332687951825763396656135637366729975121257639567151942569081995138008253909141260694278219504247960643385039649932729611760156050269813026751925974222070054700377476339563378936752904193074400715127888611166019389931458008378123152360189049273713791950489010801943196670458698643779919030483832749037450457276224893004054165699247691719595414641725657814253155441724928627136906173465867833310562416506605962220212469680743631195003521103634050821337603560290588301701596040865889503083855843394986557884944945556100592904055449870116267151820289881744593737669145921716277253162110565422264986362809375302374514493691147107428092182615316212264678504594536231491812159439899029724642495322419784462312727216082735303318714472464191610452544028257508441799798931762864864715988018364678947840698415064282872338622653781614921843768477383401228088830160953321885774522233387402007516375459644536393505823116638100179333621321400095017611673388059841225689604612490060851053572095213627696433778410111379957067154748095781374936736446450881740690435307309763773395445323295974928890549503947240983765416438316292872409377918246887291176323662563458868858131452555217996657788702611398299641850553371541552427242564221750854980931902962012028686635547627516089966407286156561459813332159539037150419561327879678933483017892715686205036514841614923381597298214857688978080050309895836002372073116267988189697095225265014606447202687121366873422812010046203954155446406512176497398958902199187683934954505035177942270807666234260421784563099426565436213900626105750326879387331585783621735516159883149795298060197599003338404202019864250034904388846601666103456534799784513665424523093761686490311179806863884227268082845554028485641071881186667339630420990536348033811374573518685174498776199153952807285764157483964672560582276713403379743570822639933025397481655098408886282660023171993551106296385527170701183133777672093213188738741694934044983293582924711799227280747933936423952460643954522511189432838833992318133436093402215845142128199633596734427838667731079213697705985167700880000426168834509392875445367485856653591422112711060014993723631726287025250240528933012106273768378351138500715338161989228016080116459136734216724127503205822742783332823682994022186248905883173293824075574351709860643483188378501317242065384232733643703800477007671245506506448819409132040977872161817999289756235480194523522496361207573434686161257665534400673589353120197460876437504167055219100215867602411096460412229429079285626829687313455227071378556727057753271604205993856464497871129467229025429547074215802004078323994886093651496186600662753953467748733605822112764756889732419163666430200039786738275552439772076955582989558501826698699205244307930848801928945717786923638908737879755698526580886002753749119517824311199565239535459743495944328212082804476388179843223579058132576774434884138498280414395932009691578799908458223727862462162517348267792744797120556934452160358567208951294773492750488980597538249497239502805023275074583865176885646664231279436272375097671515831792480205586694323948514674819096158241914861084086730146230038029178925903687272115333804362120993281043507953301957264579715851946913744157249804950757134088225209081331103699928306372835734613537073408836283565648493538290450219281361986271155570178995901695603037671788303630750211538625719029474791732114270982436148244502475225987625453208430820423770243728495708993385732000987834633973038968332320682403779372533185282387350736003580916668556752016226984103964817708169764367301733647432713197376702796924072209926215015200903604895412233023052040791250206901139981495026716929835988480330322955182770954165349145460676151947470528933066854293732077126911806037025514262502175217341119266516935266970430435686586687221511704044830195876803951216886191712932361996208153966591637741058854115931984726926395471877234990804321123897818679943442005331229659361006123821003682184718600964631416525432858662586103439119832901378590593488273914589529522529168098354134329484105776576392869271043003588742911347032098816967613528209855168254288156486216138860890485199621231868083353369428916387229362205336191575119399643960239395501449162348659292602006106445609881542323651673071183576950962378623267489699018803623453089373045430854799441436465182350062274762844819766839146628622899174925631396268622996552154198489741293389968601416787938546938413000179187947660271807946308136433080654777244653137705506524778275973917002809188019744865561074857914262025366775107914959037947935316055300044685467269655480316211607691656997277221963296026571589420385702910093313956234014290580287470710740800775121991739227925815442621575357604714760366161961606852305033257363574874222642286664956773235526288930766467143544775887655158853924584028117436526969518661333800848727404137269125708724992245320013527102903032439454937686146731236236644251899955560076677364560719237051001636472139620263613990376764707323762058262951223961863679442545168037107687223160686841088157051652125145116511027972190682608974557596973280729330951543221824468877897232543355065149890320924240623526500984311167436811828770741517261326174152190194196160834894411398301516653057903996098096777350577210537813268640448546835519494688128611437628716320798087066624978464673815910444900519121937861886812690948622113194530651737717787102024458087792007794523529513738876821246810329817159823426901579562127006149066292928826792007136959549093470296877960511054614153437428961563399076934000170041285968076539471692045791436764662441026128845038670405435646801492180091809627139564644805409289569951372982624195987330279311945725064850280462255023304846430029411342844166104267344590648173000271835390536016874950730343758331221972309317221251083873750004791284489673470854881554429194332430130208106028264843456123903540591507890627066290509050419481208501414288030965549577962623556319068798301492261251326113621001381146549654755095578415942651955697937940689009059973557256823887040416614910041698289281109611472423623331742817915753811190461438227782075653120276478594477526225339946255836104882044580743650137870239234187836464406352370893081394437977780821196100379020558313651776799202087439820892790623511128549831346687683224237311167958904514270092980552226154995550845480935380293112607479761340761547283114189620347225879629121828399336942595360072519727479517809110113801510868580800944756922402988679535268864215546651144216923869194161620309679353954274724119563407615509947186724322271491339801422012052910420364096711158184569256957243892984936667615461215962807480664364324872427309070603063714655408970108816175305871355129023247072211288258896111680582765033139170345652688583109693191303861932309889301880553965895178485256684858090531178681802660545578070532890263020044650399744838839835926984266373841008645128966784789801878328782877224312920128429094887468565913728766636896482868230658705412665604959760522984666270503028367851555525820263015204327140619576239426253160534212233365371114016087577998805966396947967209534939295499686464591363743189264038467458309394783583068318447551901762866282068169491414836212699794010057728196877366801100127798605063880906462985085114675537");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp)));

        temp = BigInteger.Parse("65785897164448191381343511924499180834109624990100754110346692714720833794182365156704520567066494452568598038317099669513516096681618601973599684423150328823149127367318079223120613816366038825604373268484954782110429835105286425333570541703714024151532084137071597682869259489221172755742364472724201391713876228852531646764843076854104581946061772267221757994736893926938160629380056553372248214368909504039212458266423980657106363733011856061121104369672147994640441778258160341955435109744447134256187215376894548013860157067815014854327054401293768815922507649024668392519266407522576716874831315048731693618952003216023606499644720147295275387516119527423680540664128864272031313852922193652901872732314717832642396584320613044874876038709312185088372090147112187657869779392688566837197222873583961493636492878943080433802748761360310302723190158716092892744929758873685478975276800670405063542783787175166169602615999466339596354504219501105673891354573209038920435930403019087822420187428656762642041998808872161199084947727133936559102364496735902940200177931856797143955996184320324843305825519761471929663872341396515529983727108459536090173169742307430044945248663781699303787795654384125310492475708658293822181665360");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp)));

        temp = BigInteger.Parse("62362385618440558416947016669824906883813410011053641792946485497339721329431721439415220243379222918320766404281447700590021891155050265114385592812878735466325208888593348836073537528761371853341648068552950252434358013341985391327537178373087155201768599524019380757016544450988505261122166827623821157388989385416619683557220268832127834874073559435984144961254858185346608192576658054546623242322471196316756094923811160906264371131392381779320586622639793335662752727861825331393639498034265911346139282451973559648859868126280816483538209855193358838624452241451974573654740521140261037836393493195199235018766811286482795967197478000411576883345741508867320043804212855588444336753360390022381829058493004310313059457501659510131594527812649374332829267428993258110432996432011983126655315265920566458028478121477367097244510948421854062842203915600005914824");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp)));

        temp = BigInteger.Parse("105304873411458465237823109840830461532297664641861909345335983651620697961501875992724194244954865033669992328452594774452926688664213255617325573108242413961035542821302346985592911344125656037430417857923745187297258902871436992889265964566408383242965076143762182878415696697321419732252675577742829165177250146537026239309456512322120322660658657500735460842080634302497836781370951570897343811129414613636887318514067098255516234127025764803768697992519955839169838829708639416834170285096476387342434255498654317390346575985930158243128857324460324557274293835174709332634562827897313");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp))); // failed with round up

        temp = BigInteger.Parse("4158778369644239253144735435452135103052920040777068394326845749479928668137113273641891938414472777155402871106641843416775631184591761508954289137159646589762108986911327059013268970766061512895207495793891523453588504760273949467854779946180645436561957963870029200019077271901983439750690458982602101659773464708927882431821592294995304801341476291809490825735434728904816304538249047761794496268396415473815044527283546569535324502176951155143748970420841309367267113066246134610984581041136088216956464090974746565616023221");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp))); // Failed for huge sqrt() - maybe failed with round up

        temp = BigInteger.Parse("179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp))); // Failed for value Double.Max

        temp = BigInteger.Parse("179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858369");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp))); // Failed for value Double.Max1

        temp = BigInteger.Parse("179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986050859197892009348423098673397576100060199749986929562362761314132383880020795324759350467498370284959417336104341480439649700322878491181830478233599");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp))); // Failed for value Double.Maxs

        temp = BigInteger.Parse("179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986050859197892009348423098673397576100060199749986929562362761314132383880020795324759350467498370284959417336104341480439649700322878491181830478233600");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp))); // Failed for value Double.Maxs

        temp = BigInteger.Parse("17494584706016591027735461995965655369485392135483279753178087315506247479908101322432716538350151127201566210005644237814513392249452453615066147272228907663966390734640115862609428708808030883561312370933224354989584163634780158683901786449438459917087336832199985240528014645163631305415749573655211490978631716429164715576326122339425754435169992953750485069221610238394718337618921655783782041008005224393274487002390986157125495569904504979630450742020277163243700439394100971116982469820853805921150898151992772979321237326399758133");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp)));

        temp = BigInteger.Parse("324869344822123891204500737190540217603582230298827943613070138634574543931529836644908557280814426421865640009546187334173413368040022188428404427615158419933534601057247685980219135338184905291081445059428169291870657858169275815840222956732487620761154654410650902413711236901782615917737119907905229234946211961080658388960638760959363844640743773892304002116832698921887645232477218304189719735593244966041503279433593532306881416962517923413587821230750081023226603959650598328121575017362314407084534778367861380310792005727284136781374900887396549343");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp)));

        temp = BigInteger.Parse("628585829943043711774780150124486302296386743285745807915546421548369772944349205519895063878854598279327388017081748928549003526040710666991887335679085821326590372431911569248580138566784523769649934299594659147063327786855481652768517809939447427274571843102808731405570448808757614071");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp)));

        temp = BigInteger.Parse("469219801800293764373197355969328553831984974596843971042368711922664472663701981746713137411270711303034626199044091413698918166643890203860091306664994072502482932661931411083539271868071588269998735494868914134645646190292788569954038367952474854129663");
        Assert.True(IsSqrt(temp, BigIntegerTools.NewtonPlusSqrt(temp)));
    }

    /// <summary>
    /// Sqrt - Verification 2: Brute Force testing (starting at 0)
    /// </summary>
    [Fact]
    public void Verify_NewtonPlusSqrt_Brute_Force()
    {
        _ = Parallel.For(0, sqrtBruteForceStoppedAt, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (x, s) =>
        {
            BigInteger root = BigIntegerTools.NewtonPlusSqrt(x);
            BigInteger lowerBound = root * root;
            BigInteger upperBound = lowerBound + (2 * root) + 1;
            Assert.False(x < lowerBound || x >= upperBound); // In: {Math.Sqrt(x)} !!!!! {(lowerBound > x ? "Lo" : "Hi")}  In:{root}^2={x}  xShouldBe: {Math.Sqrt(x)}
        });
    }

    /// <summary>
    /// Sqrt - Verification 3: 2^n + [-5 to +5] Testing
    /// </summary>
    [Fact]
    public void Verify_NewtonPlusSqrt_2_Pow_n_Testing()
    {
        Stopwatch sw = Stopwatch.StartNew();
        for (int s = 0; s < 32; s++)
        {
            _ = Parallel.For((s * 512) + 8, (s * 512) + 512 + 8, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (x, s) =>
            {
                if (sw.ElapsedMilliseconds > TestTargetInMillseconds)
                {
                    s.Stop();
                }

                for (long i = -5; i < 6; i++)
                {
                    BigInteger testVal = BigInteger.Pow(2, x) + i;

                    BigInteger root = BigIntegerTools.NewtonPlusSqrt(testVal);

                    BigInteger lowerBound = root * root;
                    BigInteger upperBound = lowerBound + (2 * root) + 1;

                    Assert.False(testVal < lowerBound || testVal >= upperBound); // testVal: 2^{x}{i} failed.
                }
            });
        }
    }

    /// <summary>
    /// Sqrt - Verification 4: 11111[n]00000[n] Testing
    /// </summary>
    [Fact]
    public void Verify_NewtonPlusSqrt_11110000()
    {
        Stopwatch sw = Stopwatch.StartNew();
        int startAt = BitOperations.Log2(sqrtBruteForceStoppedAt) - 1;

        _ = Parallel.For(startAt, 1000, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (length, s) =>
        {
            if (sw.ElapsedMilliseconds > TestTargetInMillseconds)
            {
                s.Stop();
            }

            for (int i = 1; i <= length; i++)
            {
                BigInteger v = ((BigInteger.One << i) - 1) << (length - i);
                BigInteger root = BigIntegerTools.NewtonPlusSqrt(v);

                BigInteger lowerBound = root * root;
                BigInteger upperBound = lowerBound + (2 * root) + 1;

                Assert.False(v < lowerBound || v >= upperBound); // failed: {i} 0's  {length - i} 1's
            }
        });
    }

    /// <summary>
    /// Sqrt - Verification 5: 1010101010101... Testing 
    /// example: 1, 10, 101, 1010, 10101....
    /// </summary>
    [Fact]
    public void Verify_NewtonPlusSqrt_10101010()
    {
        Stopwatch sw = Stopwatch.StartNew();
        int startAt = BitOperations.Log2(sqrtBruteForceStoppedAt) - 1;

        _ = Parallel.For(startAt, 10000, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (length, s) =>
        {
            if (sw.ElapsedMilliseconds > TestTargetInMillseconds)
            {
                s.Stop();
            }

            BigInteger v = 1;
            for (int i = 2; i < length; i += 2)
            {
                v = (v << 2) + 1;
            }
            if ((length & 1) == 0)
            {
                v <<= 1;
            }

            BigInteger root = BigIntegerTools.NewtonPlusSqrt(v);

            BigInteger lowerBound = root * root;
            BigInteger upperBound = lowerBound + (2 * root) + 1;

            Assert.False(v < lowerBound || v >= upperBound); // Failed on a '10101010101..' test with length {length}
        });
    }

    /// <summary>
    /// Sqrt - Verification 6: n^2 -[0,1] Testing
    /// note: n^2 some overlap here with the "n^[2,3,5,6,7] + [-2,-1,0,1,2] Testing"
    /// </summary>
    [Fact]
    public void Verify_NewtonPlusSqrt_Pow2()
    {
        Stopwatch sw = Stopwatch.StartNew();
        BigInteger c = (BigInteger)Math.Sqrt(sqrtBruteForceStoppedAt);

        while (sw.ElapsedMilliseconds < TestTargetInMillseconds)
        {
            _ = Parallel.For(0, 1024, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (x, s) =>
            {
                for (int i = 0; i < 2; i++)
                {
                    BigInteger valToTest = (2 * (c + x)) - i;
                    BigInteger root = BigIntegerTools.NewtonPlusSqrt(valToTest);

                    BigInteger lowerBound = root * root;
                    BigInteger upperBound = lowerBound + (2 * root) + 1;

                    Assert.False(valToTest < lowerBound || valToTest >= upperBound); // Failed on {cx}^2 - {i}
                }

                if (sw.ElapsedMilliseconds > TestTargetInMillseconds)
                {
                    s.Stop();
                }

            });

            c += 1024;
        }
    }

    /// <summary>
    /// Sqrt - Verification 7: Random number testing...
    /// </summary>
    [Fact]
    public void Verify_NewtonPlusSqrt_RandomNumberTesting()
    {
        int randomMinBitSize = -1;
        int randomMaxBitSize = 5000;

        Stopwatch sw = Stopwatch.StartNew();

        _ = Parallel.For(0, MaxDegreeOfParallelism, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (p, s) =>
        {
            Random r = new(p + RAND_SEED);
            int counter = 0;
            while (true)
            {
                //int bitLenRangeBeg = (int)Math.Log2(4e34) + 10;//BitOperations.Log2((ulong)BruteForceStoppedAt)-1; //(int)Math.Log2(4e254) -3;
                //int bitLenRangeEnd = (int)Math.Log2(4e34) + 12; //1e308

                int bitLenBeg = (randomMinBitSize >= 0) ? randomMinBitSize : (BitOperations.Log2(sqrtBruteForceStoppedAt) - 1); //(int)Math.Log2(4e254) -3;
                int bitLenEnd = randomMaxBitSize;

                int bitLen = r.Next(bitLenBeg, bitLenEnd) + 1;
                int byteCt = (bitLen + 7) / 8;
                byte[] bytes = new byte[byteCt];
                r.NextBytes(bytes);
                bytes[byteCt - 1] |= 0x80;
                bytes[byteCt - 1] >>= 7 - ((bitLen - 1) % 8);
                BigInteger x = new(bytes, true, false);
                //x += counter + p; // a little extra randomness; can cause bitLen to go over.

                if (x < sqrtBruteForceStoppedAt)
                {
                    continue;
                }

                BigInteger a01 = BigIntegerTools.NewtonPlusSqrt(x);

                BigInteger lowerBound = a01 * a01;
                BigInteger upperBound = lowerBound + (2 * a01) + 1;

                int offby = 0;
                bool failed = lowerBound > x || upperBound <= x;
                if (failed)
                {
                    for (int i = -32; i < 32; i++)
                    {
                        if (x >= ((a01 + i) * (a01 + i))) //is high
                        {
                            offby = i;
                        }
                    }
                }

                Assert.False(failed); // Failed on random number check with {x}. It is off by {offby}.

                if (counter++ % 0x1000000 == 0)
                {
                    Debug.WriteLine($"Status {string.Format("{0:T}", DateTime.Now)}: thread:{p}\tCount:{counter}\t2^{x.GetBitLength() - 1}/{(double)x}");
                }

                if (sw.ElapsedMilliseconds > TestTargetInMillseconds)
                {
                    s.Break();
                    break;
                }
            }
        });
    }

#if !DEBUG
    [Fact]
    public void VerifyNewtonPlusSqrtShouldFail1()
    {
        Assert.Throws<ArgumentException>(() => _ = BigIntegerTools.NewtonPlusSqrt(-1));
    }

    [Fact]
    public void VerifyNewtonPlusSqrtShouldFail2()
    {
        BigInteger input = (BigInteger)double.MinValue + (BigInteger)double.MinValue;
        Assert.Throws<ArgumentException>(() => _ = BigIntegerTools.NewtonPlusSqrt(input));
    }
#endif

    private static bool IsSqrt(BigInteger n, BigInteger root)
    {
        //source: https://github.com/pilotMike/Euler-Challenges-v2/blob/962f981c87e394773507bc00a708fdae202aa61c/EulerTools/Extensions/MyExtensions.cs  Michael DiLeo 2015
        BigInteger lowerBound = root * root;
        BigInteger upperBound = lowerBound + root + root + 1;
        return n >= lowerBound && n < upperBound;
    }


    [Fact]
    public void Verify_Inverse()
    {
        Assert.Equal(BigFloat.Inverse(new BigFloat("1.000")), new BigFloat("1.000")); // Failed on: Inverse(1.000)
        Assert.Equal(BigFloat.Inverse(new BigFloat("2.000")), new BigFloat("0.5000")); // Failed on: Inverse(2.000)
                                                                                       // To-Do: reviewed this and it should pass - we need to update the compare function
        Assert.Equal(BigFloat.Inverse(new BigFloat("3.000")), new BigFloat("0b0.010101010101010101010101010101010101010101010", 0, 32)); // Failed on: Inverse(3.000)
        Assert.Equal(BigFloat.Inverse(new BigFloat("0.5000")), new BigFloat("2.000")); // Failed on: Inverse(0.5000)
        Assert.Equal(BigFloat.Inverse(new BigFloat("0.3333")), new BigFloat("3.000")); // Failed on: Inverse(0.3333)

        BigFloat a = new("0.33333333333333");
        BigFloat b = new("3.0000000000000"); // 3.0000000000000
                                             // a0:  0.01010101010101010101010101010101010101010101001011111100110110...   0.333333333333325
                                             // a1:  0.01010101010101010101010101010101010101010101010111001101011011...   0.333333333333335
                                             // a2:  11.0000000000000000000000000000000000000000000 1010100 3.00000000000007500
                                             // a3:  10.1111111111111111111111111111111111111111111 1101111 2.99999999999998500
                                             // a4:   0.0000000000000000000000000000000000000000000 1100101 0.00000000000009
                                             // b1:  10.1111111111111111111111111111111111111111111 1000111 2.99999999999995
                                             // b2:  11.0000000000000000000000000000000000000000000 0111000 3.00000000000005
                                             // b3:   0.0000000000000000000000000000000000000000000 1110000 0.0000000000001
                                             // true, by a small margin, because a4 == b3
        Assert.Equal(BigFloat.Inverse(a), b); // Failed on: Inverse(0.33333333333333)

        a = new BigFloat("-0.333333333333333333333333333");
        b = new BigFloat("-3.00000000000000000000000000"); //3.00000000000000000000000000
                                                           // a0: 0.01010101010101010101010101010101010101010101010101010101010101010101010101010101010101010 00100 0.3333333333333333333333333325
                                                           // a1: 0.01010101010101010101010101010101010101010101010101010101010101010101010101010101010101010 11000 0.3333333333333333333333333335
                                                           // a2:   11.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000 10010 3.0000000000000000000000000075 (0.3333333333333333333333333325)
                                                           // a3:   10.11111111111111111111111111111111111111111111111111111111111111111111111111111111111111 11100 2.9999999999999999999999999985 (0.3333333333333333333333333335)
                                                           // a4:    0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000 10110 0.000000000000000000000000009
                                                           // b1:   11.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000 01100 3.000000000000000000000000005
                                                           // b2:   10.11111111111111111111111111111111111111111111111111111111111111111111111111111111111111 10011 2.999999999999999999999999995
                                                           // b3:    0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000 11000 0.00000000000000000000000001
                                                           // would be true, by a small margin, because a4 == b3 
                                                           // BUT 0.333333333333333333333333333 is stored with guard bits being 0x00000000 so it comes up false
        Assert.Equal(BigFloat.Inverse(a), b); // Failed on: Inverse(-0.333333333333333333333333333)

        b = new BigFloat("-3.0000"); // more true since too small (allows for larger tolerance)
        Assert.Equal(BigFloat.Inverse(a), b); // Failed on: Inverse(-0.333333333333333333333333333)

        b = new BigFloat("-3.000000000000000000000000000"); // false
        Assert.Equal(BigFloat.Inverse(a), b); // Failed on: Inverse(-0.333333333333333333333333333)

        a = new BigFloat("7.9697706335180071911585875567198e-26");
        b = new BigFloat("12547412541514775369202510");
        Assert.Equal(BigFloat.Inverse(a), b); // Failed on: Inverse(0.5000)
    }

    /// <summary>
    /// Inverse Verification 1: Common Fails
    /// </summary>
    [Fact]
    public void Verify_Inverse_Common_Fails()
    {
        _ = CheckInverse(BigInteger.MinusOne);
        _ = CheckInverse(BigInteger.One);
        BigInteger valToTest = BigInteger.Parse("8273153554255617868983008432299507701873690283447163912225368429446311715550180068658483561349865846704311797996005892990494607142525675800342567010930760478881504606029054999488050624099750939339790755426321297478858807972510657577430552150649899640468901338121294090979219428234512847003533414175726178693610069347755095659695353545360529790683181065043538446867918248788742705333365840422466199773229341881841562551926235483545177894989221351527346588987721531194144175285969973689640218042094418808237706900648114671371775300698367651383174442595695957899162146670906778789201530522867749937550298524431256635047931");
        _ = CheckInverse(valToTest);
        _ = CheckInverse(valToTest + 1);
        _ = CheckInverse(BigInteger.Parse("374622190995713598813029737925947051705809638079728648837203317232520450544987889076160147970041374918121757949602129193189627732344065706383371226187835319714209031377906"));
        _ = CheckInverse(BigInteger.Parse("285013714838916124746332799963584856696559114154526436450316172786090750322481976436201683157295661247422269749708947463647574230159095313041740438915381154333683134147981881052909187062730083973334780414971356303334003636993678034868083193818348023091003363888921565718173027783621779517877300200724459318883522235112068285932195519037519165902397752860489674895796976400390836349751427026061658964203208207986236200932628791719083132376094639338301197454891161371254361839889401887706282292505789937819779959717878950744690490451460250552140684616855021515468623300887218921710277512975593031191949892800748540749262661949870473705897585049029946162622106546347620917265696194559801244123684550639057819166981442116592210707318201455631684986737606526635568852133623155695703543483277590334799035273474221366689251730228654333498348983148060215237998018186668782906813463794675647274428135720809334669780620193631012355614590578191925576697141901"));
        _ = CheckInverse(BigInteger.Parse("645939712405401427719711254063813468156213415200850699928240890973548642930906671628067939561389768742610260274947216253535958539046510117181847336215500441547828988008499863283321060888285180958716586132295468008708718750886004174750090339672254391327068510418655854996295608654912181466562066392576946408280444645720652219224611465788921115672007871684057345123697713619795572111218976868165977088388076018155579127963692414645217516226582443109944361333778959142017020766702585614084557002374143856684835403030114576877613125361001081612661505866535992828793261026218710006019409384286248553489144084836908483354058059174031935080941095970669550752672290188012935344941625941224776598832005105461709062131845129678963155310027422917876006618051141488519807701539489712459454171376535906228081656842506129847531133807702931600418505954342868857145344054108555281592568541709103974802015219413388401920300146704419785634503745727784608594651862819775429285667691480255596598355137918884688681242925903869182365424076667891828794970711995156501553646245103285321272836088502175303126383961643724861657121768832605051542254287022038928115325910288733210686961346257986675795521419117484112569337949140264990"));
        _ = CheckInverse(BigInteger.Parse("14226342718751118987907712656792939014609116305038288508984965665170435278580333690269830569305522770533115648153109977677970505910625922454536026835852861332513459837041790011369159613511987064990374692209153941946410250817507783093926309366818470453091487613497831683214972282433680630982532763190683188379014716931664367628856712864496549434590849436602433350062473844636337430852410107263030344416723319870714159741005261604289621571405370996571482202189946969590725396299242462841573118206347715965805077151815088089898712040656448748652946583617809438541519496216169721658653723720561561601101228727064752442615455482001090437223561687360017043925134663500743462770265751193548606236574887993897708234798015778243132964667428178856994844952952767372869586443371631986024216806390351458153350155473742698605698036672929293892925483318864445513221152207924537215494391086982099603955047363639252292415150243702042020253673557543258256080860766767245166366206504042341743664890169812601231127032334294569486704846172949043552949441316944714028840689338784401867179801203613271182276331013888454830352391740343025859921596673531204457761831252242526173047406966821405710834640264664514325319700094788810229600338339048034248472906440829567003568352904106454211600272772441256937357011526350840028766974271849878883968029793821029979280359368212174059092944193932724591216533306907868949240183508100414983415165523499662280683154859830743035090387199495274469840495806979622786301340"));
        _ = CheckInverse(BigInteger.Parse("41597037944448288110263031477097654167384303281785501659348547438859712932895265129174863537442219208764808367754224325676189013224863230815238211318298805347258792422345044074873622426170281290814220505198280942180680987026072516738908213582080426073114716009829990895938425085364287895467011390686208508278438730461229031670604488583132047013295327251056792004212211984418619663447584994978851293935131110818345158735090825798050014339956039806087253671405307536505969146032086905214682999371273072327848485190337222112654049779316736398006552350156349884603007360240860067257909482396786549588732357562118172137668037090856181026987902018187123355906466294875863290720195176549809520330510535389796132984892059640168902171480943753536264315689507100966013546691280187870571451205108217441077590372742568828587495458227141473387320433587383078311146940539855321485599293540008356160519179316373740003907476816065356834101152604366223141056328388148703861540389801990631343518586799040845656241392934834522495698513979794700246917693292354190436213407849292690244331619453139129528311878463071451903744767274814238809831756377838973380878611727693240233305958509793663676407892016477218846901984357526107274350245333587892891647258020839563922086967136639138149549163501535002313407476514168371528265958304129029559790809555296315581870799758675251593555164438335668433357530966606494565841539517226231078555238897938082287091553434761476447011358899223501505465429569334182561228540892303214811082283526723697168379678479540727712438070861914927293109710911106707261295892041586638725763206110753540190896772169081260784380"));

    }

    /// <summary>
    /// Inverse Verification 2: Brute Force testing (starting at 0)
    /// </summary>
    [Fact]
    public void Verify_Inverse_Brute_Force()
    {
        _ = Parallel.For(2, inverseBruteForceStoppedAt, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (valToTest, s) =>
        {
            _ = CheckInverse(valToTest);
        });
    }

    /// <summary>
    /// Inverse Verification 3: 2^n + [-5 to +5] Testing
    /// </summary>
    [Fact]
    public void Verify_Inverse_2_Pow_n_Testing()
    {
        Stopwatch sw = Stopwatch.StartNew();
        for (int s = 0; s < 32; s++)
        {
            _ = Parallel.For((s * 512) + 8, (s * 512) + 512 + 8, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (x, s) =>
            {
                if (sw.ElapsedMilliseconds > TestTargetInMillseconds)
                {
                    s.Stop();
                }

                for (long i = -5; i < 6; i++)
                {
                    BigInteger valToTest = BigInteger.Pow(2, x) + i;
                    _ = CheckInverse(valToTest);
                }
            });
        }
    }

    /// <summary>
    /// Inverse Verification 4: 11111[n]00000[n] Testing
    /// </summary>
    [Fact]
    public void Verify_Inverse_11110000()
    {
        Stopwatch sw = Stopwatch.StartNew();
        int startAt = BitOperations.Log2(inverseBruteForceStoppedAt) - 1;

        _ = Parallel.For(startAt, 1000, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (length, s) =>
        {
            if (sw.ElapsedMilliseconds > TestTargetInMillseconds)
            {
                s.Stop();
            }

            for (int i = 1; i <= length; i++)
            {
                BigInteger valToTest = ((BigInteger.One << i) - 1) << (length - i);
                _ = CheckInverse(valToTest);
            }
        });
    }

    /// <summary>
    /// Inverse Verification 5: 1010101010101... Testing 
    /// example: 1, 10, 101, 1010, 10101....
    /// </summary>
    [Fact]
    public void Verify_Inverse_10101010()
    {
        Stopwatch sw = Stopwatch.StartNew();
        int startAt = BitOperations.Log2(inverseBruteForceStoppedAt) - 1;

        _ = Parallel.For(startAt, 10000, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (length, s) =>
        {
            if (sw.ElapsedMilliseconds > TestTargetInMillseconds)
            {
                s.Stop();
            }

            BigInteger valToTest = 1;
            for (int i = 2; i < length; i += 2)
            {
                valToTest = (valToTest << 2) + 1;
            }
            if ((length & 1) == 0)
            {
                valToTest <<= 1;
            }
            _ = CheckInverse(valToTest);

        });
    }

    /// <summary>
    // Inverse Verification 6: n^2 -[0,1] Testing
    //note: n^2 some overlap here with the "n^[2,3,5,6,7] + [-2,-1,0,1,2] Testing"
    /// </summary>
    [Fact]
    public void Verify_Inverse_Pow2()
    {
        Stopwatch sw = Stopwatch.StartNew();
        BigInteger c = (BigInteger)Math.Sqrt(inverseBruteForceStoppedAt);

        while (sw.ElapsedMilliseconds < TestTargetInMillseconds)
        {
            _ = Parallel.For(0, 1024, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (x, s) =>
            {
                for (int i = 0; i < 2; i++)
                {
                    BigInteger valToTest = (2 * (c + x)) - i;
                    _ = CheckInverse(valToTest);
                }

                if (sw.ElapsedMilliseconds > TestTargetInMillseconds)
                {
                    s.Stop();
                }
            });

            c += 1024;
        }
    }

    /// <summary>
    // Inverse Verification 7a: Random small number testing...
    /// </summary>
    [Fact]
    public void Verify_Inverse_RandomNumberTesting_Under_3000bits()
    {
        int randomMinBitSize = -1;
        int randomMaxBitSize = 3000;

        Stopwatch sw = Stopwatch.StartNew();
        int fullCounter = 0;
        _ = Parallel.For(0, MaxDegreeOfParallelism, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (p, s) =>
        {
            Random r = new(p + RAND_SEED);
            int counter = 0;
            while (true)
            {
                //int bitLenRangeBeg = (int)Math.Log2(4e34) + 10;//BitOperations.Log2((ulong)BruteForceStoppedAt)-1; //(int)Math.Log2(4e254) -3;
                //int bitLenRangeEnd = (int)Math.Log2(4e34) + 12; //1e308

                int bitLenBeg = (randomMinBitSize >= 0) ? randomMinBitSize : (BitOperations.Log2(inverseBruteForceStoppedAt) - 1); //(int)Math.Log2(4e254) -3;
                int bitLenEnd = randomMaxBitSize;

                int bitLen = r.Next(bitLenBeg, bitLenEnd) + 1;
                int byteCt = (bitLen + 7) / 8;
                byte[] bytes = new byte[byteCt];
                r.NextBytes(bytes);
                bytes[byteCt - 1] |= 0x80;
                bytes[byteCt - 1] >>= 7 - ((bitLen - 1) % 8);
                BigInteger valToTest = new(bytes, true, false);

                _ = CheckInverse(valToTest);

                fullCounter++;
                if (counter++ % 0x1000000 == 0)
                {
                    Debug.WriteLine($"Status {string.Format("{0:T}", DateTime.Now)}: thread:{p}\tCount:{counter}\t2^{valToTest.GetBitLength() - 1}/{(double)valToTest}");
                }

                if (sw.ElapsedMilliseconds > TestTargetInMillseconds)
                {
                    s.Break();
                    break;
                }
            }
        });
        //Console.WriteLine($"Total Count: {fullCounter}");
    }

    /// <summary>
    // Inverse Verification 7b: Random large number testing...
    /// </summary>
    [Fact]
    public void Verify_Inverse_RandomNumberTesting_Over_3000bits()
    {
        int randomMinBitSize = 3000;
        int randomMaxBitSize = 10000;

        Stopwatch sw = Stopwatch.StartNew();
        int fullCounter = 0;
        _ = Parallel.For(0, MaxDegreeOfParallelism, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (p, s) =>
        {
            Random r = new(p + RAND_SEED);
            int counter = 0;
            while (true)
            {
                //int bitLenRangeBeg = (int)Math.Log2(4e34) + 10;//BitOperations.Log2((ulong)BruteForceStoppedAt)-1; //(int)Math.Log2(4e254) -3;
                //int bitLenRangeEnd = (int)Math.Log2(4e34) + 12; //1e308

                int bitLenBeg = (randomMinBitSize >= 0) ? randomMinBitSize : (BitOperations.Log2(inverseBruteForceStoppedAt) - 1); //(int)Math.Log2(4e254) -3;
                int bitLenEnd = randomMaxBitSize;

                int bitLen = r.Next(bitLenBeg, bitLenEnd) + 1;
                int byteCt = (bitLen + 7) / 8;
                byte[] bytes = new byte[byteCt];
                r.NextBytes(bytes);
                bytes[byteCt - 1] |= 0x80;
                bytes[byteCt - 1] >>= 7 - ((bitLen - 1) % 8);
                BigInteger valToTest = new(bytes, true, false);

                _ = CheckInverse(valToTest);

                fullCounter++;
                if (counter++ % 0x1000000 == 0)
                {
                    Debug.WriteLine($"Status {string.Format("{0:T}", DateTime.Now)}: thread:{p}\tCount:{counter}\t2^{valToTest.GetBitLength() - 1}/{(double)valToTest}");
                }

                if (sw.ElapsedMilliseconds > TestTargetInMillseconds)
                {
                    s.Break();
                    break;
                }
            }
        });
        //Console.WriteLine($"Total Count: {fullCounter}");
    }

#if !DEBUG
    [Fact]
    public void VerifyInverseShouldFailOnZeroInput()
    {
        Assert.Throws<DivideByZeroException>(() => _ = BigIntegerTools.Inverse(0));
    }

    [Fact]
    public void VerifyInverseShouldFailOnNegativePrecision()
    {
        Assert.Throws<ArgumentException>(() => _ = BigIntegerTools.Inverse(1,-1));
    }
#endif

    private static bool CheckInverse(BigInteger x)
    {
        BigInteger xInvRes = BigIntegerTools.Inverse(x);
        BigInteger xInvTst = InverseClassic(x);

        int correctBits = 0;
        bool success = xInvRes == xInvTst;
        StringBuilder sb = new();

        if (!success)
        {
            _ = sb.AppendLine($"Inverse Fail with input {x}");
            _ = sb.AppendLine($"  Result: {xInvRes} !=");
            _ = sb.AppendLine($"  Answer: {xInvTst}");

            if (xInvRes.GetBitLength() != x.GetBitLength())
            {
                _ = sb.AppendLine($"  Result length incorrect:  [{xInvRes.GetBitLength()}] != [{x.GetBitLength(),-4}]");
            }

            if (xInvTst.GetBitLength() != x.GetBitLength())
            {
                _ = sb.AppendLine($"  Classic length incorrect: [{xInvTst.GetBitLength()}] != [{x.GetBitLength(),-4}]");
            }

            correctBits = BigIntegerTools.ToBinaryString(xInvRes).Zip(BigIntegerTools.ToBinaryString(xInvTst), (c1, c2) => c1 == c2).TakeWhile(b => b).Count();
            if (xInvRes.GetBitLength() - correctBits > 0)
            {
                _ = sb.AppendLine($"  incorrect bits:[{xInvRes.GetBitLength() - correctBits}]  CorrectBits:[{correctBits}] of [{xInvRes.GetBitLength()}]");
            }

            Assert.True(false); // sb.ToString()
        }

        return success;

        static BigInteger InverseClassic(BigInteger x, int requestedPrecision = 0)
        {
            int xLen = (int)x.GetBitLength();
            if (requestedPrecision == 0)
            {
                requestedPrecision = xLen;
            }
            else if (requestedPrecision < 0)
            {
                throw new DivideByZeroException("'precisionBits' can not be negative.");
            }
            return x.IsPowerOfTwo
                ? (BigInteger.One * x.Sign) << (int)BigInteger.TrailingZeroCount(x)
                : (BigInteger.One << (xLen + ((requestedPrecision == 0) ? xLen : requestedPrecision) - 1)) / x;
        }
    }
}